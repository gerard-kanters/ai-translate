jQuery(document).ready(function($) {
    // Zorg ervoor dat de taalcode uit de cookie wordt geladen
    function getLanguageFromCookie() {
        var name = "ai_translate_lang=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    // Function to toggle the language popup visibility
    window.toggleLanguages = function() {
        $('#languagePopup').toggleClass('show');
    }

    // Close popup when clicking outside
    $(document).on('click', function(e) {
        const switcher = $('.ai-translate-switcher');
        // If the click is outside the switcher and the popup is shown, hide it
        if (!switcher.is(e.target) && switcher.has(e.target).length === 0 && $('#languagePopup').hasClass('show')) {
            $('#languagePopup').removeClass('show');
        }
    });

     // Handle language selection
     $('.lang-option').on('click', function(e) {
        e.preventDefault(); // Prevent default link behavior first
        var lang = $(this).data('lang');
        var url = $(this).attr('href'); // Get the URL generated by PHP

        // Set cookie for language preference (expires in 30 days)
        var expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();
        document.cookie = 'ai_translate_lang=' + encodeURIComponent(lang) + ';path=/;expires=' + expires + ';SameSite=Lax';

        // Get default language from the global object
        var defaultLang = window.aiTranslateDetectable ? window.aiTranslateDetectable.default_language : 'nl'; // Default to 'nl' if not set

        // Navigate to the URL provided in the href
        // Force reload if switching to default language and URL is the same
        if (lang === defaultLang && window.location.href === url) {
            window.location.reload(true); // Force hard reload
        } else {
            window.location.href = url;
        }
    });

    // Ensure the current language button itself doesn't trigger the document click listener immediately
    $('.current-lang').on('click', function(e) {
        e.stopPropagation(); // Prevent click from bubbling up to the document
        toggleLanguages(); // Call the toggle function
    });

    // Zet cookie als er een geldige taalcode in de URL staat, maar cookie nog niet gezet is of afwijkt
    (function() {
        if (typeof window.aiTranslateDetectable === 'object') {
            var enabled = window.aiTranslateDetectable.enabled_languages || [];
            var detectable = window.aiTranslateDetectable.detectable_languages || [];
            var allLangs = enabled.concat(detectable.filter(function(l){return enabled.indexOf(l)===-1;}));
            var defaultLang = window.aiTranslateDetectable.default_language || 'nl';

            var urlLangMatch = window.location.pathname.match(/^\/([a-z]{2,3})(\/|$)/i);
            if (urlLangMatch) {
                var urlLang = urlLangMatch[1].toLowerCase();
                if (allLangs.indexOf(urlLang) !== -1) {
                    // Check cookie
                    var cookieLang = (function() {
                        var m = document.cookie.match(/ai_translate_lang=([^;]+)/);
                        return m ? decodeURIComponent(m[1]) : '';
                    })();
                    if (cookieLang !== urlLang) {
                        var expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();
                        document.cookie = 'ai_translate_lang=' + encodeURIComponent(urlLang) + ';path=/;expires=' + expires + ';SameSite=Lax';
                    }
                }
            }
        }
    })();

    // Detecteer browsertaal en stel cookie in als nodig (alleen bij eerste bezoek)
    (function() {
        // Deze waarden worden door PHP als globale JS-variabelen gezet in de admin-page of footer
        if (typeof window.aiTranslateDetectable === 'object') {
            var detectable = window.aiTranslateDetectable.detectable_languages || [];
            var enabled = window.aiTranslateDetectable.enabled_languages || [];
            var defaultLang = window.aiTranslateDetectable.default_language || 'nl';

            // Alleen als er geen cookie is en geen taal in de URL
            var hasCookie = document.cookie.indexOf('ai_translate_lang=') !== -1;
            var urlLangMatch = window.location.pathname.match(/^\/([a-z]{2})(\/|$)/i);
            if (!hasCookie && !urlLangMatch && detectable.length > 0) {
                var browserLangs = (navigator.languages || [navigator.language || navigator.userLanguage || '']).map(function(l) {
                    return l.substr(0, 2).toLowerCase();
                });
                var found = null;
                for (var i = 0; i < browserLangs.length; i++) {
                    var lang = browserLangs[i];
                    if (detectable.indexOf(lang) !== -1 && lang !== defaultLang) {
                        found = lang;
                        break;
                    }
                }
                if (found) {
                    // Zet cookie en redirect naar juiste taal-URL
                    var expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();
                    document.cookie = 'ai_translate_lang=' + encodeURIComponent(found) + ';path=/;expires=' + expires + ';SameSite=Lax';
                    // Redirect naar /[lang]/...
                    var path = window.location.pathname;
                    if (path === '/') {
                        window.location.pathname = '/' + found + '/';
                    } else {
                        window.location.pathname = '/' + found + path;
                    }
                }
            }
        }
    })();

});